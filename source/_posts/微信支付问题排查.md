---
title: 微信支付问题排查
date: 2018-07-17
tags: [支付]
categories: [第三方支付]
---

#### 问题描述

今天运营小哥哥发来一个问题订单说是用户钱已经支付过了，但是咱们这边的状态还是待支付状态。我问他是哪个支付渠道，他说微信，我就知道又要填坑了。从接触支付开始微信支付的问题就没有断过，虽然阿里文档写的一般但人家API确实做得不错，看微信一个支付通知还他妈是XML格式，你弄个json不好吗。。。

言归正传，就是用户付了钱，咱们状态没有同步更新，微信服务器状态是支付成功，咱们这边是未支付，后续的业务又是以咱们的状态为准的，所以所有的后续业务都无法进行了。这种情况要么手动给用户把钱退掉，要么手动将状态改为支付成功。

说重试的老哥听我往下讲，因为微信的签名方式比较佛性，他是先将业务参数和verify key拼接为字符串之后再使用MD5加密之后给过来的。然后他给你sign的时候比较自我，就它觉得该给你那些就是那些，也不管你这边Object是否有对应参数去接受，反正就硬塞你。那既然参数对不上，他给过来的签名和咱们自己解析出来的参数是必然对不上的，那这样就算你重试一万遍也是这样，签名验不过，状态就同步不了。

#### 排查过程

##### 微信支付流程
从官网上捞下来一张微信APP支付的流程图。问题出现在第15步，收到通知但是验签失败。
![image](https://pay.weixin.qq.com/wiki/doc/api/img/chapter8_3_1.png)

##### 很烦的问题排查过程
因为查询日志是微信最后一步通知支付状态的时候会将他使用MD5加密的签名（已无力吐槽为什么要用MD5）给过来，然后这个参数就是验不过，很烦。
![image](http://otqvaruzt.bkt.clouddn.com/7292cee32684bf2bb00dd92d82e3843.png)

然后我检查了参数，没有发现异常，并且还和那个验签成功的参数做了对比，也没有发现问题，然后还是不死心又做了本地Junit模拟签名验签，也符合预期。
![image](http://otqvaruzt.bkt.clouddn.com/20180717-02.png)
可以看到MD5处理之后的数据和解析之后的签名数据不一样，很奇怪，参数都是我复制粘贴的，为什么会不一致。

借下来我又去翻看日志看到了微信通知过来的原始XML数据，坑就在这里。还要再吐槽一遍，为什么要用XML，为什么不用json。

![image](http://otqvaruzt.bkt.clouddn.com/1070717-03.png)

能看到微信通知的是SUCCESS，说明确实是支付成功了，确实也收到用户的money了，可恨的是这四个字段是什么鬼，查了[微信文档](https://pay.weixin.qq.com/wiki/doc/api/app/app.php?chapter=9_7&index=3)之后才知道是用户使用了代金券，即类似支付宝鼓励奖之类的玩意。

微信生成签名的时候把这四个字段加进去了，但是我们这边貌似没有验签的时候压根就没有用上这些玩意。申请微信支付的就限制了用户不能使用微信优惠，文档上也标识的非必传，所以就没有添加字段接收，那自然签名就不一样了。微信用了18个字段生成的签名，但是我们是用14个字段去验签，再怎么重试都验不过，结果都一样。

#### 解决
然后我把这四个参数加了上去，然后再去模拟验签就没有问题了。
![image](http://otqvaruzt.bkt.clouddn.com/20170717-04.png)

#### 总结
在对接三方支付的时候技术和商务一定要一致，像能不能用优惠券这种在申请的时候就应该同步好，这样对接的时候这些不必要的参数就算不加也不会有问题，当然最好的解决方案肯定是做成可配置的，这样解决问题只是一种quick fix。