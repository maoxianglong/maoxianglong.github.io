---
title: 一次异常排查
date: 2018-07-03
tags: [解决问题]
categories: [异常排查]
---

#### 事件背景

所负责的接入服务需要和第三方模块进行通信，通信使用的HTTPS双向认证，负责的模块作为服务端提供服务，客户端设置了timeout时间为10s，检查服务端证书也是ok的，请求也能正常收到，说明建立连接是没有问题的，服务端代码逻辑检查也是no problem，但客服端反应就是一直503异常，比较奇葩，绕过Nginx证书之后做模拟测试也是ok的，下面说说我入坑已经排查的过程，记录一下，以后遇到也不会浪费我这么多时间。

#### 排查过程

##### 查看Nginx日志

多次跑到运维同事工位去麻烦运维老哥一次又一次的监控Nginx日志，老哥告诉我所有的请求都是200，并没有看见我说的503，由此排除不是Nginx转发的异常。

#### 模拟外网请求

在postman上配置了证书做了模拟请求，确实出现了503的异常，猜想可能是证书问题，后来又让运维老哥确认了近期证书是否做过修改，经确认，证书没有动过，过期时间到了遥远的2029年，也不可能过期，排除证书问题。

PS：有老哥说都什么年代还postman，我只想说我连postman都没怎么用过，配个证书都弄了我半天。所以不要觉得这样很low，对于笔者来说已经很棒棒了。。。

![image](http://otqvaruzt.bkt.clouddn.com/image1.jpg)

#### 模拟内网请求

排查了上面两个问题之后我只能觉得是代码逻辑有问题，然后我再服务器直接访问内网的http接口，绕过了证书，结果大呼过瘾。我先用了事发现场的city_code（因为业务上是将每一个城市和cicy_code对应的），事发现场只有SUZHOU才出现，其他城市都是ok的。

我先用事故city_code做了内网请求，请求的时候我看表，是16:10:00，然后高潮来了，笔者等了好久好久都没有看到响应过来，以为是服务端报错了，正准备去监控日志时响应过来了，而此时笔者又看了下表，16:10:11。坑的一笔，生成一个订单号花了11s，而客户端只设置10s的timeout时间，所以人家最多等你10s，你花个11s去生成订单，还没算上网路上传输的时候，10s早过了，过了10s你再给人家响应人家才不鸟你。so，至于为什么不报read time out而是503，这个笔者也母鸡啊，一会再去看看。

使用事故city_code做内网访问，可以看到虽然能正常响应，但是花了10s，笔者没有设置打印时间戳，信我就是了。
![image](http://otqvaruzt.bkt.clouddn.com/image2.jpg)

#### 继续往下找
能够定位到是代码性能瓶颈问题就好解决了，笔者验这个请求链路一路顺藤摸瓜找到了问题模块。前几天在某某客户端上线SUZHOU的时候配置有些问题，在做查询的时候花了10s，捞出SQL让专业的DBA小哥哥优化之后就好啦。